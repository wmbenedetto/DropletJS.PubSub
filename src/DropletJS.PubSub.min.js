/** @license DropletJS.PubSub | MIT License | https://github.com/wmbenedetto/DropletJS.PubSub#mit-license */(function(){window=typeof window!="undefined"?window:null,global=typeof global!="undefined"?global:null})(),function(e,t){typeof Function.prototype.bind!="function"&&(Function.prototype.bind=function(e){var t=this;return function(){return t.apply(e,arguments)}});var u=function(e){return typeof e=="object"&&e!==null&&typeof e.length=="number"},a=function(e){return typeof e=="object"&&e!==null&&typeof e.length!="number"},f=function(e,n){try{delete e[n]}catch(r){e[n]=t}},l=function(t){this.namespace=this.DEFAULT_NS,t.indexOf(":")>-1&&(this.namespace=t.substr(0,t.indexOf(":")),t=t.substr(t.indexOf(":")+1,t.length));if(t.indexOf(".")>-1){var n=t.split(".");this.msgArray=[n[0]||"*",n[1]||"*",n[2]||"*",n[3]||"*"],this.msgString=this.msgArray.join(".")}else this.msgArray=[t],this.msgString=t};l.prototype={DEFAULT_NS:"__default",matches:function(e){if(this.msgString===e)return!0;var t=this.msgArray,n=e.split(".");if(t.length!==n.length)return!1;var r="",i="",s=t.length>=n.length?t.length:n.length;for(var o=0;o<s;o++){if(t[o]!=="*"&&n[o]!=="*"&&t[o]!==n[o])return!1;r+=t[o]==="*"?"0":"1",i+=n[o]==="*"?"0":"1"}return r>=i},toString:function(){return this.msgString}};var c={handlers:{},subscribers:{before:[],after:[]},getAPI:function(){return{clear:this.clear.bind(this),listen:this.listen.bind(this),once:this.once.bind(this),publish:this.publish.bind(this),stop:this.stop.bind(this),subscribe:this.subscribe.bind(this),unsubscribe:this.unsubscribe.bind(this)}},listen:function(){var e=this.processListenArgs(Array.prototype.slice.call(arguments));if(u(e.message))return this.each(e,this.listen.bind(this)),null;this.addHandler(e)},once:function(){var e=this.processListenArgs(Array.prototype.slice.call(arguments));e.limit=1;if(u(e.message))return this.each(e,this.once.bind(this)),null;this.addHandler(e)},stop:function(e){if(!e)throw new Error("Message(s) must be passed to stop()");var t={message:this.toMessage(e)};if(u(t.message))return this.each(t,this.stop.bind(this)),null;this.removeHandlers(t)},subscribe:function(){var e=this.processSubscribeArgs(Array.prototype.slice.call(arguments)),t=e.phase;this.subscribers[t]=this.subscribers[t]||[],this.subscribers[t].push(e)},unsubscribe:function(){var e=this.processUnsubscribeArgs(Array.prototype.slice.call(arguments));if(!e.phase)return this.unsubscribe(e.namespace,"before"),this.unsubscribe(e.namespace,"after"),null;var t=e.namespace,n=e.phase,r=this.subscribers[n];if(u(r))for(var i=0;i<r.length;i++)(!t||r[i].namespace===t)&&r.splice(i,1)},publish:function(){var e=this.processPublishArgs(Array.prototype.slice.call(arguments));if(u(e.message)){var t=e.onComplete;return e.onComplete=null,this.each(e,this.publish.bind(this),t),null}var n=e.message.toString(),r=e.message,i=e.payload,s=e.onPublish,o=this.subscribers.before.concat(this.getHandlers(r)).concat(this.subscribers.after);for(var a=0;a<o.length;a++){if(o[a].limit===null||o[a].count<o[a].limit){var f=o[a].async?o[a].handler(r,i,s):o[a].handler(r,i);o[a].async!==!0&&typeof s=="function"&&s(f),o[a].count+=1}typeof o[a].limit=="number"&&o[a].count===o[a].limit&&this.removeHandlers(e,a)}typeof e.onComplete=="function"&&e.onComplete()},getHandlers:function(e){var t=[];for(var n in this.handlers)this.handlers.hasOwnProperty(n)&&e.matches(n)&&(t=t.concat(this.handlers[n]));return t},clear:function(){this.handlers={},this.subscribers={before:[],after:[]}},each:function(e,t,n){for(var r=0;r<e.message.length;r++){var i={};for(var s in e)e.hasOwnProperty(s)&&s!=="message"&&(i[s]=e[s]);i.message=e.message[r],t(i)}typeof n=="function"&&n()},addHandler:function(e){var t=e.message.toString();this.handlers[t]=this.handlers[t]||[],this.handlers[t].push({namespace:e.message.namespace,handler:e.handler,async:e.async,limit:typeof e.limit=="number"?e.limit:null,count:0})},removeHandlers:function(e,t){var n=e.message.toString(),r=e.message.namespace,i=this.handlers;if(i&&i[n]){if(typeof t=="number")i[n][t].namespace===r&&i[n].splice(t,1);else for(var o=0;o<i[n].length;o++)i[n][o].namespace===r&&i[n].splice(o,1);i[n].length===0&&f(i,n)}},processListenArgs:function(e){var t={};a(e[0])?t=e[0]:(t.message=typeof e[0]=="string"||u(e[0])?e[0]:null,t.handler=typeof e[1]=="function"?e[1]:null);if(!t.message||typeof t.handler!="function")throw new Error("Message(s) and handler function must be passed to listen() and/or once()");return t.message=this.toMessage(t.message),t},processSubscribeArgs:function(e){var t={};a(e[0])?t=e[0]:t.handler=typeof e[0]=="function"?e[0]:null;if(typeof t.handler!="function")throw new Error("Handler must be passed to subscribe()");t.phase=t.phase||"after",t.limit=null,t.count=0;if(!t.phase||t.phase in{before:1,after:1})return t;throw new Error(t.phase+" is not a valid phase for subscribe().")},processUnsubscribeArgs:function(e){var t={};a(e[0])?t=e[0]:(t.namespace=typeof e[0]=="string"?e[0]:null,t.phase=typeof e[1]=="string"?e[1]:null);if(!t.phase||t.phase in{before:1,after:1})return t;throw new Error(t.phase+" is not a valid phase for unsubscribe().")},processPublishArgs:function(e){var t={};a(e[0])?t=e[0]:(t.message=typeof e[0]=="string"||u(e[0])?e[0]:null,t.payload=typeof e[1]!="undefined"?e[1]:null);if(!t.message)throw new Error("Message(s) must be passed to publish()");return t.message=this.toMessage(t.message),t.async&&typeof t.onPublish!="function"&&(t.onPublish=function(){}),t},toMessage:function(e){if(u(e)){var t=[];for(var n=0;n<e.length;n++)e[n]instanceof l||(t[n]=new l(e[n]));e=t}else e&&!(e instanceof l)&&(e=new l(e));return e},log:function(e,t,n,r){},setLogLevel:function(e){r=e}};typeof define=="function"?define(function(){return c}):typeof module!="undefined"&&module.exports?module.exports=c:(e.DropletJS=typeof e.DropletJS=="object"&&e.DropletJS!=="null"?e.DropletJS:{},e.DropletJS.PubSub=c)}(window||global);
