if(typeof MINIFIED==="undefined"){MINIFIED=false}(function(){window=typeof window!=="undefined"?window:null;global=typeof global!=="undefined"?global:null})();(function(root,undefined){if(!MINIFIED){var logLevels={OFF:0,ERROR:1,WARN:2,INFO:3,DEBUG:4,TRACE:5};var logLevel="OFF";var console=window.console||{};console.log=typeof console.log==="function"?console.log:function(){};console.info=typeof console.info==="function"?console.info:console.log;console.error=typeof console.error==="function"?console.error:console.log;console.warn=typeof console.warn==="function"?console.warn:console.log;var log=function(funcName,message,payload,level){payload=!payload?"":payload;level=!level?"INFO":level.toUpperCase();message="["+funcName+"()] "+message;if(isLoggable(level)){if(level==="ERROR"){console.error(message,payload)}else if(level==="WARN"){console.warn(message,payload)}else if(level==="INFO"){console.info(message,payload)}else{console.log(message,payload)}}};var isLoggable=function(level){var currentLogLevel=logLevels[logLevel];var thisLogLevel=logLevels[level];return thisLogLevel<=currentLogLevel}}if(typeof Function.prototype.bind!=="function"){Function.prototype.bind=function(scope){var self=this;return function(){return self.apply(scope,arguments)}}}var isArray=function(options){return typeof options==="object"&&options!==null&&typeof options.length==="number"};var isObjLiteral=function(options){return typeof options==="object"&&options!==null&&typeof options.length!=="number"};var safeDelete=function(obj,prop){try{delete obj[prop]}catch(e){obj[prop]=undefined}};var Message=function Message(msgString){this.namespace=this.DEFAULT_NS;if(msgString.indexOf(":")>-1){this.namespace=msgString.substr(0,msgString.indexOf(":"));msgString=msgString.substr(msgString.indexOf(":")+1,msgString.length)}if(msgString.indexOf(".")>-1){var msgArray=msgString.split(".");this.msgArray=[msgArray[0]||"*",msgArray[1]||"*",msgArray[2]||"*",msgArray[3]||"*"];this.msgString=this.msgArray.join(".")}else{this.msgArray=[msgString];this.msgString=msgString}};Message.prototype={DEFAULT_NS:"__default",matches:function(msgString){if(this.msgString===msgString){return true}var msg1Array=this.msgArray;var msg2Array=msgString.split(".");if(msg1Array.length!==msg2Array.length){return false}var msg1Bitmask="";var msg2Bitmask="";var longerMessageLength=msg1Array.length>=msg2Array.length?msg1Array.length:msg2Array.length;for(var i=0;i<longerMessageLength;i++){if(msg1Array[i]!=="*"&&msg2Array[i]!=="*"&&msg1Array[i]!==msg2Array[i]){return false}msg1Bitmask+=msg1Array[i]==="*"?"0":"1";msg2Bitmask+=msg2Array[i]==="*"?"0":"1"}return msg1Bitmask>=msg2Bitmask},toString:function(){return this.msgString}};var PubSub={handlers:{},subscribers:{before:[],after:[]},getAPI:function(){return{clear:this.clear.bind(this),listen:this.listen.bind(this),once:this.once.bind(this),publish:this.publish.bind(this),stop:this.stop.bind(this),subscribe:this.subscribe.bind(this),unsubscribe:this.unsubscribe.bind(this)}},listen:function(){var options=this.processListenArgs(Array.prototype.slice.call(arguments));if(!MINIFIED){this.log("listen","Adding listener",options)}if(isArray(options.message)){this.each(options,this.listen.bind(this));return null}this.addHandler(options)},once:function(){var options=this.processListenArgs(Array.prototype.slice.call(arguments));options.limit=1;if(!MINIFIED){this.log("once","Adding one-time listener",options)}if(isArray(options.message)){this.each(options,this.once.bind(this));return null}this.addHandler(options)},stop:function(message){if(message){throw new Error("Message(s) must be passed to stop()")}var options={message:this.toMessage(message)};if(!MINIFIED){this.log("stop","Stopping listener",options)}if(isArray(options.message)){this.each(options,this.stop.bind(this));return null}this.removeHandlers(options)},subscribe:function(){var options=this.processSubscribeArgs(Array.prototype.slice.call(arguments));var phase=options.phase;if(!MINIFIED){this.log("subscribe","Adding subscriber",options)}this.subscribers[phase]=this.subscribers[phase]||[];this.subscribers[phase].push(options)},unsubscribe:function(){var options=this.processUnsubscribeArgs(Array.prototype.slice.call(arguments));if(!options.phase){this.unsubscribe(options.namespace,"before");this.unsubscribe(options.namespace,"after");return null}var namespace=options.namespace;var phase=options.phase;var subscribers=this.subscribers[phase];if(!MINIFIED){this.log("unsubscribe","Unsubscribe from "+phase+" phase"+(namespace?" in "+namespace+" namespace":""),options)}if(isArray(subscribers)){for(var i=0;i<subscribers.length;i++){if(!namespace||subscribers[i].namespace===namespace){subscribers.splice(i,1)}}}},publish:function(){var options=this.processPublishArgs(Array.prototype.slice.call(arguments));if(isArray(options.message)){var onComplete=options.onComplete;options.onComplete=null;this.each(options,this.publish.bind(this),onComplete);return null}var msgString=options.message.toString();if(!MINIFIED){this.log("publish","# START publishing "+msgString,options)}var message=options.message;var payload=options.payload;var onPublish=options.onPublish;var publishTo=this.subscribers["before"].concat(this.getHandlers(message)).concat(this.subscribers["after"]);for(var i=0;i<publishTo.length;i++){if(publishTo[i].limit===null||publishTo[i].count<publishTo[i].limit){var result=publishTo[i].async?publishTo[i].handler(message,payload,onPublish):publishTo[i].handler(message,payload);if(publishTo[i].async!==true&&typeof onPublish==="function"){onPublish(result)}publishTo[i].count+=1}if(typeof publishTo[i].limit==="number"&&publishTo[i].count===publishTo[i].limit){this.removeHandlers(options,i)}}if(!MINIFIED){this.log("publish","# END publishing "+msgString,options)}if(typeof options.onComplete==="function"){options.onComplete()}},getHandlers:function(message){var handlers=[];for(var msgString in this.handlers){if(this.handlers.hasOwnProperty(msgString)&&message.matches(msgString)){handlers=handlers.concat(this.handlers[msgString])}}return handlers},clear:function(){if(!MINIFIED){this.log("clear","Clearing PubSub")}this.handlers={};this.subscribers={before:[],after:[]}},each:function(data,fn,onComplete){for(var i=0;i<data.message.length;i++){var thisData={};for(var j in data){if(data.hasOwnProperty(j)&&j!=="message"){thisData[j]=data[j]}}thisData.message=data.message[i];fn(thisData)}if(typeof onComplete==="function"){onComplete()}},addHandler:function(options){var msgString=options.message.toString();if(!MINIFIED){this.log("addHandler","Adding handler for "+msgString+" message",null,"TRACE")}this.handlers[msgString]=this.handlers[msgString]||[];this.handlers[msgString].push({namespace:options.message.namespace,handler:options.handler,async:options.async,limit:typeof options.limit==="number"?options.limit:null,count:0})},removeHandlers:function(options,handlerNum){var msgString=options.message.toString();var namespace=options.message.namespace;var handlers=this.handlers;if(handlers&&handlers[msgString]){if(!MINIFIED){var logMsg="Removing handler for "+msgString+" message";logMsg+=namespace!==options.message.DEFAULT_NS?" in "+namespace+" namespace":"";this.log("removeHandlers",logMsg,null,"TRACE")}if(typeof handlerNum==="number"){if(handlers[msgString][handlerNum].namespace===namespace){handlers[msgString].splice(handlerNum,1)}}else{for(var i=0;i<handlers[msgString].length;i++){if(handlers[msgString][i].namespace===namespace){handlers[msgString].splice(i,1)}}}if(handlers[msgString].length===0){safeDelete(handlers,msgString)}}},processListenArgs:function(args){var options={};if(isObjLiteral(args[0])){options=args[0]}else{options.message=typeof args[0]==="string"||isArray(args[0])?args[0]:null;options.handler=typeof args[1]==="function"?args[1]:null}if(!options.message||typeof options.handler!=="function"){throw new Error("Message(s) and handler function must be passed to listen() and/or once()")}options.message=this.toMessage(options.message);return options},processSubscribeArgs:function(args){var options={};if(isObjLiteral(args[0])){options=args[0]}else{options.handler=typeof args[0]==="function"?args[0]:null}if(typeof options.handler!=="function"){throw new Error("Handler must be passed to subscribe()")}options.phase=options.phase||"after";options.limit=null;options.count=0;if(options.phase&&!(options.phase in{before:1,after:1})){throw new Error(options.phase+" is not a valid phase for subscribe().")}return options},processUnsubscribeArgs:function(args){var options={};if(isObjLiteral(args[0])){options=args[0]}else{options.namespace=typeof args[0]==="string"?args[0]:null;options.phase=typeof args[1]==="string"?args[1]:null}if(options.phase&&!(options.phase in{before:1,after:1})){throw new Error(options.phase+" is not a valid phase for unsubscribe().")}return options},processPublishArgs:function(args){var options={};if(isObjLiteral(args[0])){options=args[0]}else{options.message=typeof args[0]==="string"||isArray(args[0])?args[0]:null;options.payload=typeof args[1]!=="undefined"?args[1]:null}if(!options.message){throw new Error("Message(s) must be passed to publish()")}options.message=this.toMessage(options.message);if(options.async&&typeof options.onPublish!=="function"){options.onPublish=function(){}}return options},toMessage:function(message){if(isArray(message)){var messageArray=[];for(var i=0;i<message.length;i++){if(!(message[i]instanceof Message)){messageArray[i]=new Message(message[i])}}message=messageArray}else if(message&&!(message instanceof Message)){message=new Message(message)}return message},log:function(funcName,message,payload,level){if(!MINIFIED){log("DropletJS.PubSub."+funcName,message,payload,level)}},setLogLevel:function(level){logLevel=level}};if(typeof define==="function"){define(function(){return PubSub})}else if(typeof module!=="undefined"&&module.exports){module.exports=PubSub}else{root.DropletJS=typeof root.DropletJS==="object"&&root.DropletJS!=="null"?root.DropletJS:{};root.DropletJS.PubSub=PubSub}})(window||global);